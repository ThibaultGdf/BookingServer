# 12. Rôles

- [x] Ajouter le rôle `admin` dans le middlewares/authenticate.middleware.js.
```javascript
const isAdmin = (req, res, next) => {
 if (req.user && req.user.role === "admin") {
    next();
 } else {
    console.log(req.user);
    res.status(403).json({ message: 'Unauthorized : Accès non autorisé !'})
 }
}

module.exports = { verifyJwt, isAdmin };
```

<br>

- [x] Protéger les routes dans lesquels nous souhaitons avoir le rôle `admin`.
```javascript
const authenticateMiddleware = require('../middlewares/authenticate.middleware.js');

// AVANT 
router.post('/', categoryController.post);

// APRES
router.post('/', authenticateMiddleware.isAdmin, categoryController.post);
```

<br>

- [x] Ajouter la route dans `users.route.js` pour éditer le rôle d'un utilisateur.
```javascript
const authenticateMiddleware = require('../middlewares/authenticate.middleware.js')

router.put('/editRole/:id', authenticateMiddleware.isAdmin, userController.editRole);
```

<br>

- [x] Ajouter son controller dans `/controllers/user.controller.js`.
```javascript
const editRole = async function(req, res) {
    try {
        const id = req.params.id
        const user = await User.findByPk(id);
    
        if (!user) {
            return res.status(404).json({message: `L'utilisateur n'existe pas !`})
        }
    
        user.role = req.body.role
    
        await user.save();
    
        res.status(200).json({message: `Le rôle a bien été modifié à l'utilisateur ${id}`})
    } catch(error) {
        return res.status(500).json({message: `${error}. Erreur serveur lors de la modification d'un rôle !`})
    }
};
```

<br> 

- [x] Exporter la fonction
```javascript
// AVANT
module.exports = { getOne, getAll, put, destroy };

// APRES
module.exports = { getOne, getAll, put, editRole, destroy };
```

<br>

- [x] Ajouter le rôle par défaut de l'utilisateur lors de la création du compte dans la fonction `signIn`.
```javascript
const user = {
        firstname: firstname,
        lastname: lastname,
        birthday: birthday,
        phone_number: phone_number,
        role: "user",
        email: email,
        password: hashedPassword,
        picture: picture
    };
```

<br>

- [x] Ajouter le `role` dans le payload.
```javascript
  const payload = {
            id: user.id,
            email: user.email,
            role: user.role
        }
```

<br>

- [x] Ajouter le rôle dans la migration et le model.

```javascript
// Model
 User.init({
    firstname: DataTypes.STRING,
    lastname: DataTypes.STRING,
    birthday: DataTypes.DATE,
    phone_number: DataTypes.STRING,
    role: DataTypes.STRING,
    email: DataTypes.STRING,
    password: DataTypes.STRING,
    picture: DataTypes.STRING
  }, {
    sequelize,
    modelName: 'User',
  });

// Migration
   role: {
        type: Sequelize.STRING
      },
```

<br>


- [x] Ajouter le rôle dans le seeder.
